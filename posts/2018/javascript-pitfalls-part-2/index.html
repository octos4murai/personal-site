<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>JavaScript Pitfalls, Part 2 | Al Idian</title>

    <meta name="description" content="A personal site about software development">

    <link rel="preconnect" href="https://fonts.gstatic.com"> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&amp;family=Merriweather&amp;display=swap">

    <link rel="stylesheet" href="/css/syntax-highlight.css">
    <link rel="stylesheet" href="/css/style.css">

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
</head>
<body>
    <header>
        <h3 id="site-title" class="no-margin no-padding"><a href="/">Al Idian</a></h3>
    </header>

    <main>
        
<h1 id="post-title">JavaScript Pitfalls, Part 2</h1>
<p id="post-date" class="gray-text">2018.09.28</p>

<p>This blog post is part two of series JavaScript Pitfalls where I attempt to demonstrate design flaws in the JavaScript language. To read the first part, click here: <a href="/posts/2018/javascript-pitfalls-part-1">JavaScript Pitfalls, Part 1</a>.</p>
<h3>Constructors and the <em>new</em> keyword</h3>
<p>In JavaScript, constructors are nothing but functions meant to create objects. In other words, the difference between functions and constructors is not in their implementation but in their usage. For example, examine the two examples below and note that syntactically there is little difference between the former (function) and the latter (constructor):</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Function</span><br><span class="token keyword">let</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Invoking the function</span><br><br><span class="token comment">// Constructor</span><br><span class="token keyword">let</span> <span class="token function-variable function">Bar</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Using the constructor</span></code></pre>
<p>By convention, the variable <em>foo</em> to which the function was assigned is in <em>camelCase</em> while the variable <em>Bar</em> to which the constructor was assigned is in <em>PascalCase</em>. Constructors are also invoked with the keyword <em>new</em>, triggering the creation of a new object.</p>
<p>Since a constructor is just a function invoked with the keyword <em>new</em>, if we ever forget to write <em>new</em>, no error will be thrown. The JavaScript engine will simply invoke the function instead of creating a new object and using the function as a constructor. As you can imagine, this behaviour can cause bugs which are difficult to detect.</p>
<h3>Arrays, objects, and for loops</h3>
<p>In most languages other than JavaScript, the choice between using for loops and foreach loops comes down to readability and conveying the developer’s intent. Specifically, foreach loops tell readers “that you are planning to do something to each member of a collection irrespective of its place in the collection.” (<a href="https://stackoverflow.com/a/1946941">Stack Overflow</a>) In this sense, foreach loops can be thought of as a special case of for loops.</p>
<p>In JavaScript, however, I would advise against using foreach loops, instead opting towards for loops. Let me explain why:</p>
<pre class="language-javascript"><code class="language-javascript"><mark class="highlight-line highlight-line-active"><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"><span class="token keyword">let</span> elements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// Example: for loop</span></span><br><span class="highlight-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> elemIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> elemIndex <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> elemIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>elemIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prints 1 2 3 4 5</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// Example: foreach loop</span></span><br><span class="highlight-line"><span class="token comment">// Note: Javascript has deprecated the old 'for each' syntax.</span></span><br><span class="highlight-line"><span class="token comment">// Instead, a 'for in' syntax is used. Nevertheless, it is still a foreach loop.</span></span><br><span class="highlight-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> element <span class="token keyword">in</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prints 0 1 2 3 4 foo bar</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Among the two examples above, the first does what we probably expect it to do (i.e. print 1 2 3 4 5), while the latter’s behaviour may seem strange. To understand why, it is helpful to know how arrays are implemented in Js.</p>
<p>JavaScript arrays are implemented as objects — and JavaScript objects are simply key-value pairs. Each element in the array is a value in the array object, and its key is its index in said array. Therefore, the elements array in the above example can be represented as:</p>
<blockquote>
<p>{ <strong>0</strong>: 1, <strong>1</strong>: 2, <strong>2</strong>: 3, <strong>3</strong>: 4, <strong>4</strong>: 5 }</p>
</blockquote>
<p>From this, we can see that printing the variable <em>element</em> in the foreach loop outputs the implicit indices (keys) of the array object. But why are there two additional elements printed — ‘foo’ and ‘bar’?</p>
<p>Well, in the highlighted lines above, I added those values to properties of the same name on the <em>Array.prototype</em> object. This makes it so that every <em>Array</em> object created after that point inherits properties <em>foo</em> and <em>bar</em>.</p>
<p>While I made the <em>Array.prototype</em> property assigments glaringly obvious in this example, in real non-trivial applications, this can quickly become very hard to debug. Many times, we just cannot ensure that the object we are looping on has not been tampered with either within our own code or within a library our code uses. Thus, my personal rule is to make things simple and stick with for loops in JavaScript.</p>
<h3>Inner Functions and <em>this</em></h3>
<p>The example below shows the creation of an object <em>myObj</em> and two functions within it <em>buggyFun</em> and <em>fixedFun</em>. Within each of these functions, another function — we call this an inner function — is declared and set to be invoked when a user clicks within the browser window:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">let</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token function-variable function">buggyFun</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token function-variable function">fixedFun</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">myObj<span class="token punctuation">.</span><span class="token function">buggyFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Clicking prints 'undefined'</span></span><br><span class="highlight-line">myObj<span class="token punctuation">.</span><span class="token function">fixedFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Clicking prints 'bar'</span></span></code></pre>
<p>Developers who are inexperienced in JavaScript may have a hard time spotting what is wrong with the first function <em>buggyFun</em>. While the <em>this</em> keyword in the highlighted line points to <em>myObj</em> (i.e. myObj.foo === ‘foo’ is true), <em>this</em> in the inner function no longer points to the same object. Once again, this Js quirk is particularly hard to debug especially for beginners.</p>
<p>We address this in <em>fixedFun</em>, where we saved a reference to <em>myObj</em> in the variable <em>self</em>. Then within our inner function, we use the saved reference in <em>self</em> to log the value in myObj.bar. This is just one of several ways of dealing with this prevalent JavaScript pitfall — but what is most important is being aware that the pitfall exists.</p>
<h3>In summary</h3>
<p>While it is far from perfect and is the butt of too many nerdy jokes, by and large JavaScript <em>is</em> the language of the Internet. In recent years, it has managed to encroach even into areas such as desktop development and IOT (largely with the help of Google’s V8 engine). With so many JavaScript libraries and frameworks fighting for developers’ attention, it is understandable that many devs find the JavaScript ecosystem to be volatile and somewhat transient.</p>
<p>While frameworks like Node and React are certainly some of the trendiest JavaScript stacks for good reason, I think it is also crucial for JavaScript devs to have more than a surface-level knowledge of vanilla JavaScript. While occasionally clumsy and error-prone, vanilla JavaScript can occasionally surprise with its simplicity and elegance(?!).</p>
<p>Deep knowledge in vanilla JavaScript can help developers reinforce their understanding of how and why popular JavaScript frameworks do what they do.</p>

    </main>

    <footer>
        <p class="center-text no-margin no-padding"><a href="https://github.com/octos4murai/personal-site/blob/master/LICENSE">MIT License</a></p>
        <p class="center-text no-margin no-padding"><a href="https://github.com/octos4murai/personal-site">/octos4murai</a></p>
    </footer>
</body>
</html>
